{block content}

    <table>
        <thead>
        <tr>
            <th>Serial Number</th>
            <th>Order Number</th>
            <th>Adventure Name</th>
            <th>Provider Name</th>
            <th>Coordinator Name</th>
            <th>Participants Count</th>
            <th>Estimated Cost</th>
            <th>Actual cost</th>
            <th>Budget</th>
            <th>Approved</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {foreach $adventures as $adventure}

            {skipIf $adventure->approved === false}

            <tr>
                <td>{$iterator->counter}</td>
                <td>{$adventure->orderNumber}</td>
                <td>{$adventure->adventureName}</td>
                <td>{$adventure->providerName}</td>
                <td>{$adventure->coordinatorName}</td>
                <td>{$adventure->participantsCount}</td>
                <td>{$adventure->estimatedCost}</td>
                <td>
                    {if $adventure->actualCost}
                        <p>{$adventure->actualCost}</p>
                    {else}
                        <input type="number" id="actual-cost-{$adventure->adventureId}" placeholder="Enter cost">
                        <button type="button" id="actual-cost-button-{$adventure->adventureId}" onclick="updateActualCost({$adventure->adventureId})">Save</button>
                    {/if}
                </td>
                <td>
                    {if isset($adventure->budget)}
                        {sprintf(
                        '%d - Semester %d, Part %d',
                        $adventure->budget->year,
                        $adventure->budget->semester,
                        $adventure->budget->part
                        )}
                    {else}
                        No budget assigned
                    {/if}
                </td>
                <td>
                    {if !isset($adventure->approved)}
                        <form>
                            <button type="button" class="approval-button" data-adventure-id="{$adventure->adventureId}" data-approval-status="1">Approve</button>
                            <button type="button" class="approval-button" data-adventure-id="{$adventure->adventureId}" data-approval-status="0">Disapprove</button>
                        </form>
                    {else}
                        <p>Approved ✔️</p>
                    {/if}
                </td>
                <td>
                    <a n:href="Adventure:edit $adventure->adventureId">Upravit akci</a>
                </td>
            </tr>
        {/foreach}
        </tbody>
    </table>

    <br>

    <hr>

    <br>

    <div>
        <a n:href="Adventure:add">Přidat akci</a>
    </div>
    <div>
        <a n:href="Adventure:addExcel">Přidat akci (excel)</a>
    </div>

    <br>

    <hr>

    <br>

    <div>

        <table>
            <thead>
            <tr>
                <th>Year part</th>
                <th>Value</th>
            </tr>
            </thead>
            <tbody>
            <tr n:foreach="$budgetCalculation as $item => $key">
                <td>{$item}</td>
                <td>{$key}</td>
            </tr>
            </tbody>
        </table>

    </div>

{/block}


{block script}

    <script>

        function updateActualCost(adventureId) {
            const inputElement = document.getElementById('actual-cost-' + adventureId);
            const buttonElement = document.getElementById('actual-cost-button-' + adventureId);
            const actualCost = inputElement.value;

            if (!actualCost || isNaN(actualCost)) {
                alert('Please enter a valid number.');
                return;
            }

            const xhttp = new XMLHttpRequest();
            xhttp.open("POST", {$basePath} + "/adventure/update-actual-cost?", true);
            xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhttp.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            xhttp.onload = function () {
                if (xhttp.status >= 200 && xhttp.status < 300) {
                    const response = JSON.parse(xhttp.responseText);
                    if (response.success) {
                        inputElement.outerHTML = '<p>' + actualCost + '</p>';

                        if (buttonElement && buttonElement.parentNode) {
                            buttonElement.parentNode.removeChild(buttonElement);
                        }

                        const nextElement = inputElement.nextElementSibling;
                        if (nextElement) {
                            nextElement.remove();
                        }

                        console.log('Actual cost updated successfully.');
                    } else {
                        alert(response.message);
                        console.error('Failed to update actual cost.');
                    }
                } else {
                    console.error('Request failed with status:', xhttp.status);
                }
            };

            xhttp.onerror = function () {
                console.error('Request failed.');
            };
            xhttp.send('adventureId=' + encodeURIComponent(adventureId) + '&actualCost=' + encodeURIComponent(actualCost));
        }


        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.approval-button').forEach(function (button) {
                button.addEventListener('click', function () {
                    let adventureId = this.getAttribute('data-adventure-id'); /* This JS part was made by chatGPT I forgot to link, I changed inputs and I need fast js request  */
                    let approvalStatus = this.getAttribute('data-approval-status');

                    const xhttp = new XMLHttpRequest();

                    const url = {$basePath} + `/adventure/update-approval?adventureId=${ adventureId}&approvalStatus=${ approvalStatus}`;

                    xhttp.open("POST", url, true);
                    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhttp.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

                    xhttp.onload = function () {
                        if (xhttp.status >= 200 && xhttp.status < 300) {
                            let response = JSON.parse(xhttp.responseText);
                            if (response.success) {
                                console.log('Approval status updated.');
                            } else {
                                console.error('Failed to update approval status.');
                            }
                        } else {
                            console.error('Request failed with status:', xhttp.status);
                        }
                    };

                    xhttp.onerror = function () {
                        console.error('Request failed.');
                    };

                    xhttp.send();
                });
            });
        });
    </script>







{/block}
